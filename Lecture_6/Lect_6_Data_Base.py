# –°–æ–∑–¥–∞–Ω–∏–µ SQL-—Ç–∞–±–ª–∏—Ü —Å –ø–æ–º–æ—â—å—é metadata

# https://lectureswww.readthedocs.io/6.www.sync/2.codding/9.databases/2.sqlalchemy/1.metadata.html

# –°–æ–∑–¥–∞–µ–º —Å—Ö–µ–º—É –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –Ω–∞ SQLAlchemy

# https://habr.com/ru/articles/541256/

# –¢–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ë–î

# https://docs.sqlalchemy.org/en/14/core/type_basics.html#module-sqlalchemy.types

# –†–ê–ë–û–¢–ê –° –ë–ê–ó–û–ô –î–ê–ù–ù–´–•

# –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

"""
FastAPI –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é –ø–æ–¥–¥–µ—Ä–∂–∫—É —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö. –ú—ã
–æ–±—Å—É–¥–∏–º, –∫–∞–∫ —Å–æ–∑–¥–∞—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –±–∞–∑—ã
–¥–∞–Ω–Ω—ã—Ö –≤ FastAPI. FastAPI –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞–∑–ª–∏—á–Ω—ã–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö, —Ç–∞–∫–∏–µ –∫–∞–∫ SQLite,
PostgreSQL, MySQL –∏ MongoDB. –í—ã–±–æ—Ä –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∏
–ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π –ø—Ä–æ–µ–∫—Ç–∞.

–†–∞—Å—Å–º–æ—Ç—Ä–∏–º, –∫–∞–∫ —Å–æ–∑–¥–∞—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –±–∞–∑—ã
–¥–∞–Ω–Ω—ã—Ö —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º SQLAlchemy ORM –∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö SQLite.
SQLite ‚Äî —ç—Ç–æ –æ–±–ª–µ–≥—á–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ–ª—è—Ü–∏–æ–Ω–Ω—ã–º–∏ –±–∞–∑–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–∞
–æ—Å–Ω–æ–≤–µ SQL.

–ß—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö, –Ω–∞–º –Ω—É–∂–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
–±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É ORM (Object-Relational Mapping), —Ç–∞–∫—É—é –∫–∞–∫
Tortoise ORM, SQLAlchemy –∏–ª–∏ Peewee

üî• –í–∞–∂–Ω–æ! –ï—Å–ª–∏ –≤—ã –Ω–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–ª–∏ SQLAlchemy –∏ databases —Ä–∞–Ω—å—à–µ,
–≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–º–∞–Ω–¥—ã:

pip install sqlalchemy
pip install databases[aiosqlite]

–ü—Ä–∏–º–µ—Ä:
"""
import databases
import sqlalchemy
from fastapi import FastAPI

DATABASE_URL = "sqlite:///mydatabase.db"

database = databases.Database(DATABASE_URL)

metadata = sqlalchemy.MetaData()
...
engine = sqlalchemy.create_engine(DATABASE_URL)
metadata.create_all(engine)

app = FastAPI()


@app.on_event("startup")
async def startup():
    await database.connect()


@app.on_event("shutdown")
async def shutdown():
    await database.disconnect()


"""
–í —ç—Ç–æ–º –ø—Ä–∏–º–µ—Ä–µ –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º SQLAlchemy –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ
–¥–∞–Ω–Ω—ã—Ö SQLite. –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è DATABASE_URL –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å—Ç—Ä–æ–∫—É –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.

–°–æ–±—ã—Ç–∏–µ –∑–∞–ø—É—Å–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ö–µ–º—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö. –°–æ–±—ã—Ç–∏–µ
–≤—ã–∫–ª—é—á–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —è–¥—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
"""
"""
!!!! # –¢.–∫. –º–µ—Ç–æ–¥—ã on_event –Ω–µ –±—É–¥—É—Ç –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å—Å—è –≤ –±–æ–ª–µ–µ –Ω–æ–≤—ã—Ö –≤–µ—Ä—Å–∏—è—Ö, –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å lifespan

@asynccontextmanager
async def lifespan(app: FastAPI):
    await database.connect()
    print("–ë–∞–∑–∞ –≥–æ—Ç–æ–≤–∞")
    yield
    await database.disconnect()
    print("–ë–∞–∑–∞ –æ—á–∏—â–µ–Ω–∞")

app = FastAPI(lifespan=lifespan)
"""
# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL

"""
–ï—Å–ª–∏ –º—ã —Ö–æ—Ç–∏–º –∑–º–µ–Ω–∏—Ç—å SQLite –Ω–∞ PostgreSQL, –¥–æ—Å—Ç–æ—Ç–æ—á–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤
–∫–æ–Ω—Å—Ç–∞–Ω—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î:

–£–∫–∞–∑–∞–≤ —Ç–∏–ø –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö, –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –ø–∞—Ä–æ–ª—å, —Ö–æ—Å—Ç –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
–º—ã —É—Å—Ç–∞–Ω–æ–≤–∏–º —Å –Ω–µ–π —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.
"""
DATABASE_URL = "postgresql://user:password@localhost/dbname"

# –°–æ–∑–¥–∞–Ω–∏–µ API –æ–ø–µ—Ä–∞—Ü–∏–π CRUD

"""
–û–±—Å—É–¥–∏–º, –∫–∞–∫ —Å–æ–∑–¥–∞—Ç—å API –æ–ø–µ—Ä–∞—Ü–∏–π CRUD (—Å–æ–∑–¥–∞–Ω–∏–µ, —á—Ç–µ–Ω–∏–µ, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏
—É–¥–∞–ª–µ–Ω–∏–µ) —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º FastAPI –∏ SQLAlchemy ORM.
–û–ø–µ—Ä–∞—Ü–∏–∏ CRUD ‚Äî —ç—Ç–æ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ –ª—é–±–æ–º
–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏, —É–ø—Ä–∞–≤–ª—è–µ–º–æ–º –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö. –û–Ω–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è, —á—Ç–µ–Ω–∏—è,
–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏ —É–¥–∞–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö. –í FastAPI —Å SQLAlchemy ORM –º—ã
–º–æ–∂–µ–º —Å–æ–∑–¥–∞–≤–∞—Ç—å —ç—Ç–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏, –∏—Å–ø–æ–ª—å–∑—É—è —Ñ—É–Ω–∫—Ü–∏–∏ –∏ –º–µ—Ç–æ–¥—ã Python.
‚óè CREATE, –°–æ–∑–¥–∞—Ç—å: –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.
‚óè READ, –ß—Ç–µ–Ω–∏–µ: –ø–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
‚óè UPDATE, –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ: –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–ø–∏—Å–µ–π –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.
‚óè DELETE, –£–¥–∞–ª–∏—Ç—å: —É–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
"""

# –†–∞–±–æ—Ç–∞ —Å –ë–î –≤ CRUD –æ–ø–µ—Ä–∞—Ü–∏—è—Ö —Å SQLAlchemy –∏ databases

"""
–î–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –≤ –æ–ø–µ—Ä–∞—Ü–∏—è—Ö CRUD —Å SQLAlchemy ORM –Ω–∞–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
—Å–Ω–∞—á–∞–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö. –ú—ã –º–æ–∂–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª—é–±—É—é
–±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –ø–æ –Ω–∞—à–µ–º—É –≤—ã–±–æ—Ä—É, —Ç–∞–∫—É—é –∫–∞–∫ MySQL, PostgreSQL –∏–ª–∏ SQLite. 

–ü–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –º—ã —É—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ, –º—ã –º–æ–∂–µ–º –≤—ã–ø–æ–ª–Ω—è—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–∏ CRUD –≤ –±–∞–∑–µ
–¥–∞–Ω–Ω—ã—Ö, –∏—Å–ø–æ–ª—å–∑—É—è SQLAlchemy ORM.

–ù–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–µ–¥–ø–æ–ª–æ–∂–∏–º, —á—Ç–æ —É –Ω–∞—Å –µ—Å—Ç—å –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö SQLite, –≤ –∫–æ—Ç–æ—Ä–æ–π –º—ã —Å–æ–∑–¥–∞–¥–∏–º
—Ç–∞–±–ª–∏—Ü—É –ø–æ–¥ –Ω–∞–∑–≤–∞–Ω–∏–µ–º ¬´–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏¬ª. –ú—ã –º–æ–∂–µ–º –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö,
–∏—Å–ø–æ–ª—å–∑—É—è —Å–ª–µ–¥—É—é—â–∏–π –∫–æ–¥:
"""
import databases
import sqlalchemy
from fastapi import FastAPI, create_engine
from pydantic import BaseModel

DATABASE_URL = "sqlite:///mydatabase.db"

database = databases.Database(DATABASE_URL)
metadata = sqlalchemy.MetaData()

users = sqlalchemy.Table(
    "users",
    metadata,
    sqlalchemy.Column("id", sqlalchemy.Integer, primary_key=True),
    sqlalchemy.Column("name", sqlalchemy.String(32)),
    sqlalchemy.Column("email", sqlalchemy.String(128)),
)
engine = create_engine(DATABASE_URL, connect_args={"check_same_thread": False})

metadata.create_all(engine)

"""
üí° –í–Ω–∏–º–∞–Ω–∏–µ! –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é SQLite —Ä–∞–∑—Ä–µ—à–∞–µ—Ç –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å —Å –Ω–∏–º
—Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ–º—É –ø–æ—Ç–æ–∫—É, –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞—è, —á—Ç–æ –∫–∞–∂–¥—ã–π –ø–æ—Ç–æ–∫ –±—É–¥–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å
–Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–π –∑–∞–ø—Ä–æ—Å. –≠—Ç–æ —Å–¥–µ–ª–∞–Ω–æ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ
–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –æ–¥–Ω–æ–≥–æ –∏ —Ç–æ–≥–æ –∂–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –≤–µ—â–µ–π (–¥–ª—è
—Ä–∞–∑–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤). –ù–æ –≤ FastAPI –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –æ–±—ã—á–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π (def)
–Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ—Ç–æ–∫–æ–≤ –º–æ–≥—É—Ç –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–¥–Ω–æ–≥–æ –∏
—Ç–æ–≥–æ –∂–µ –∑–∞–ø—Ä–æ—Å–∞, –ø–æ—ç—Ç–æ–º—É –Ω–∞–º –Ω—É–∂–Ω–æ —Å–æ–æ–±—â–∏—Ç—å SQLite, —á—Ç–æ –æ–Ω –¥–æ–ª–∂–µ–Ω
—Ä–∞–∑—Ä–µ—à–∞—Ç—å —ç—Ç–æ —Å –ø–æ–º–æ—â—å—é connect_args={"check_same_thread": False}.
"""
# –°–æ–∑–¥–∞–Ω–∏–µ –º–æ–¥–µ–ª–µ–π –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å —Ç–∞–±–ª–∏—Ü–µ–π –≤ –ë–î

"""–°–æ–∑–¥–∞–¥–∏–º –¥–≤–µ –º–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö Pydantic:"""


class UserIn(BaseModel):
    name: str = Field(max_length=32)
    email: str = Field(max_length=128)


class User(BaseModel):
    id: int
    name: str = Field(max_length=32)
    email: str = Field(max_length=128)


"""
–ü–µ—Ä–≤–∞—è –º–æ–¥–µ–ª—å –Ω—É–∂–Ω–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞. –ê
–≤—Ç–æ—Ä–∞—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –∏–∑ –ë–î –∫–ª–∏–µ–Ω—Ç—É.
"""
# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –ë–î
"""
–ü—Ä–µ–∂–¥–µ —á–µ–º —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º API –∏ –ø—Ä–æ—Ö–æ–¥–∏—Ç—å –≤—Å—é —Ü–µ–ø–æ—á–∫—É CRUD –¥–ª—è
–∫–ª–∏–µ–Ω—Ç–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.
"""


@app.get("/fake_users/{count}")
async def create_note(count: int):
    for i in range(count):
        query = users.insert().values(name=f"user{i}", email=f"mail{i}@mail.ru")
        await database.execute(query)
    return {"message": f"{count} fake users create"}


"""
–ü—Ä–∏–Ω–∏–º–∞–µ–º —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ count –∏ —Å–æ–∑–¥–∞—ë–º –≤ –ë–î —É–∫–∞–∑–∞–Ω–Ω–æ–µ —á–∏—Å–ª–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å
–∏–º–µ–Ω–∞–º–∏ –∏ –ø–æ—á—Ç–∞–º–∏. –¢–µ–ø–µ—Ä—å –º—ã –≥–æ—Ç–æ–≤—ã –Ω–µ —Ç–æ–ª—å–∫–æ —Ä–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å CRUD, –Ω–æ –∏
—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ.

ÔøΩ –í–∞–∂–Ω–æ! –ù–µ –∑–∞–±—É–¥—å—Ç–µ –ø–µ—Ä–µ–π—Ç–∏ –ø–æ –∞–¥—Ä–µ—Å—É http://127.0.0.1:8000/fake_users/25
—á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

ÔøΩ –í–Ω–∏–º–∞–Ω–∏–µ! –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ –ø–æ–¥–æ–±–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å
–æ—Ç–∫–ª—é—á–µ–Ω—ã –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–∞–º –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω.
"""
# –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ CRUD
"""–°–æ–∑–¥–∞–¥–∏–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ REST API."""

# ‚û¢–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î, create

"""
–ß—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–∞–±–ª–∏—Ü–µ ¬´users¬ª, –º—ã –º–æ–∂–µ–º –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å
—Ñ—É–Ω–∫—Ü–∏—é —Å–ª–µ–¥—É—é—â–∏–º –æ–±—Ä–∞–∑–æ–º
"""


# –¥–ª—è —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∏ –≤–º–µ—Å—Ç–æ user.dict() —Å–µ–π—á–∞—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è user.model_dump()
@app.post("/users/", response_model=User)
async def create_user(user: UserIn):
    query = users.insert().values(name=user.name, email=user.email)
    # –∑–∞–ø—Ä–æ—Å insert() –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç id (primary key)
    last_record_id = await database.execute(query)
    return {**user.dict(), "id": last_record_id}


"""
–ú—ã –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –º–∞—Ä—à—Ä—É—Ç "/users/" –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –í –ø–∞—Ä–∞–º–µ—Ç—Ä–µ
—Ñ—É–Ω–∫—Ü–∏–∏ –º—ã –æ–∂–∏–¥–∞–µ–º –æ–±—ä–µ–∫—Ç —Ç–∏–ø–∞ UserIn, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–º—è –∏ email
–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ó–∞—Ç–µ–º –º—ã —Å–æ–∑–¥–∞–µ–º SQL-–∑–∞–ø—Ä–æ—Å –Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –∑–∞–ø–∏—Å–∏ –≤ —Ç–∞–±–ª–∏—Ü—É
"users" —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏. –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ
—Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –≤–∫–ª—é—á–∞—è –µ–≥–æ ID.
"""

# ‚û¢–ß—Ç–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ –ë–î, read
"""
–ß—Ç–æ–±—ã –ø—Ä–æ—á–∏—Ç–∞—Ç—å –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ —Ç–∞–±–ª–∏—Ü—ã ¬´users¬ª, –º—ã –º–æ–∂–µ–º –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å
—Ñ—É–Ω–∫—Ü–∏—é —Å–ª–µ–¥—É—é—â–∏–º –æ–±—Ä–∞–∑–æ–º
"""


@app.get("/users/", response_model=List[User])
async def read_users():
    query = users.select()
    return await database.fetch_all(query)


"""
–ú—ã –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –º–∞—Ä—à—Ä—É—Ç "/users/" –¥–ª—è —á—Ç–µ–Ω–∏—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –í —Ñ—É–Ω–∫—Ü–∏–∏ –º—ã
—Å–æ–∑–¥–∞–µ–º SQL-–∑–∞–ø—Ä–æ—Å –Ω–∞ –≤—ã–±–æ—Ä–∫—É –≤—Å–µ—Ö –∑–∞–ø–∏—Å–µ–π –∏–∑ —Ç–∞–±–ª–∏—Ü—ã "users". –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å
–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –≤–∏–¥–µ —Å–ø–∏—Å–∫–∞ –æ–±—ä–µ–∫—Ç–æ–≤ —Ç–∏–ø–∞ User.
"""
# ‚û¢–ß—Ç–µ–Ω–∏–µ –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î, read

"""
–ß—Ç–æ–±—ã –ø—Ä–æ—á–∏—Ç–∞—Ç—å –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ —Ç–∞–±–ª–∏—Ü—ã ¬´users¬ª, –º—ã –º–æ–∂–µ–º –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å
—Ñ—É–Ω–∫—Ü–∏—é —Å–ª–µ–¥—É—é—â–∏–º –æ–±—Ä–∞–∑–æ–º:
"""


@app.get("/users/{user_id}", response_model=User)
async def read_user(user_id: int):
    query = users.select().where(users.c.id == user_id)
    return await database.fetch_one(query)


"""
–ú—ã –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –º–∞—Ä—à—Ä—É—Ç "/users/{user_id}" –¥–ª—è —á—Ç–µ–Ω–∏—è –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –µ–≥–æ
ID. –í –ø–∞—Ä–∞–º–µ—Ç—Ä–µ —Ñ—É–Ω–∫—Ü–∏–∏ –º—ã –æ–∂–∏–¥–∞–µ–º –ø–µ—Ä–µ–¥–∞—á—É ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ó–∞—Ç–µ–º –º—ã —Å–æ–∑–¥–∞–µ–º
SQL-–∑–∞–ø—Ä–æ—Å –Ω–∞ –≤—ã–±–æ—Ä–∫—É –∑–∞–ø–∏—Å–∏ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã "users" —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º ID. –í—ã–ø–æ–ª–Ω—è–µ–º
–∑–∞–ø—Ä–æ—Å –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –≤–∏–¥–µ –æ–±—ä–µ–∫—Ç–∞ —Ç–∏–ø–∞ User.
"""

# ‚û¢–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î, update
"""
–ß—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–∞–±–ª–∏—Ü–µ ¬´users¬ª, –º—ã –º–æ–∂–µ–º –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å
—Ñ—É–Ω–∫—Ü–∏—é —Å–ª–µ–¥—É—é—â–∏–º –æ–±—Ä–∞–∑–æ–º:
"""


# –¥–ª—è —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∏ –≤–º–µ—Å—Ç–æ user.dict() –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è user.model_dump()
@app.put("/users/{user_id}", response_model=User)
async def update_user(user_id: int, new_user: UserIn):
    query = users.update().where(users.c.id == user_id).values(**new_user.model_dump())
    await database.execute(query)
    # return {**new_user.dict(), "id": user_id}
    return {**new_user.model_dump(), "id": user_id}


"""
–ú—ã –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –º–∞—Ä—à—Ä—É—Ç "/users/{user_id}" –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ
–µ–≥–æ ID. –í –ø–∞—Ä–∞–º–µ—Ç—Ä–µ —Ñ—É–Ω–∫—Ü–∏–∏ –º—ã –æ–∂–∏–¥–∞–µ–º –ø–µ—Ä–µ–¥–∞—á—É ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –æ–±—ä–µ–∫—Ç–∞ —Ç–∏–ø–∞
UserIn, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ó–∞—Ç–µ–º –º—ã —Å–æ–∑–¥–∞–µ–º
SQL-–∑–∞–ø—Ä–æ—Å –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ "users" —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º ID –∏ –Ω–æ–≤—ã–º–∏
–¥–∞–Ω–Ω—ã–º–∏. –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
"""
# ‚û¢–£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î, delete
"""–ß—Ç–æ–±—ã —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Ç–∞–±–ª–∏—Ü—ã ¬´users¬ª, –º—ã –º–æ–∂–µ–º –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é
—Å–ª–µ–¥—É—é—â–∏–º –æ–±—Ä–∞–∑–æ–º:
"""


@app.delete("/users/{user_id}")
async def delete_user(user_id: int):
    query = users.delete().where(users.c.id == user_id)
    await database.execute(query)
    return {"message": "User deleted"}


"""
–ú—ã –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –º–∞—Ä—à—Ä—É—Ç "/users/{user_id}" –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –µ–≥–æ ID. –í
–ø–∞—Ä–∞–º–µ—Ç—Ä–µ —Ñ—É–Ω–∫—Ü–∏–∏ –º—ã –æ–∂–∏–¥–∞–µ–º –ø–µ—Ä–µ–¥–∞—á—É ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ó–∞—Ç–µ–º –º—ã —Å–æ–∑–¥–∞–µ–º
SQL-–∑–∞–ø—Ä–æ—Å –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã "users" —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º ID. –í—ã–ø–æ–ª–Ω—è–µ–º
–∑–∞–ø—Ä–æ—Å –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
"""

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π CRUD
"""
–ß—Ç–æ–±—ã –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—à API –æ–ø–µ—Ä–∞—Ü–∏–π CRUD, –º—ã –º–æ–∂–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–∞–∫–∏–µ
–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã, –∫–∞–∫ Postman –∏–ª–∏ Swagger UI. –ú—ã –º–æ–∂–µ–º –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å HTTP-–∑–∞–ø—Ä–æ—Å—ã –∫
–Ω–∞—à–µ–º—É API –∏ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å —Å–æ–∑–¥–∞–Ω–∏—è, —á—Ç–µ–Ω–∏—è, –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏ —É–¥–∞–ª–µ–Ω–∏—è
–¥–∞–Ω–Ω—ã—Ö.
–ú—ã –º–æ–∂–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—É—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –∏–ª–∏ curl –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —ç—Ç–∏—Ö
–∫–æ–Ω–µ—á–Ω—ã—Ö —Ç–æ—á–µ–∫, –æ—Ç–ø—Ä–∞–≤–ª—è—è HTTP-–∑–∞–ø—Ä–æ—Å—ã —Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏.
–ù–∞–ø—Ä–∏–º–µ—Ä, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –º—ã –º–æ–∂–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å POST
–Ω–∞ –∫–æ–Ω–µ—á–Ω—É—é —Ç–æ—á–∫—É ¬´ /users ¬ª —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–µ–ª–µ –∑–∞–ø—Ä–æ—Å–∞.

curl -X 'POST' \
'http://127.0.0.1:8000/users/' \
-H 'accept: application/json' \
-H 'Content-Type: application/json' \
-d '{
"name": "Alex",
"email": "my@mail.ru"
}'

–ó–∞—Ç–µ–º –º—ã –º–æ–∂–µ–º —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±—ã–ª —Å–æ–∑–¥–∞–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö, –æ—Ç–ø—Ä–∞–≤–∏–≤
–∑–∞–ø—Ä–æ—Å GET –Ω–∞ –∫–æ–Ω–µ—á–Ω—É—é —Ç–æ—á–∫—É ¬´ /users ¬ª –∏ –ø—Ä–æ–≤–µ—Ä–∏–≤, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç
–≤ –æ—Ç–≤–µ—Ç–µ.
–°–æ–∑–¥–∞–Ω–∏–µ API –æ–ø–µ—Ä–∞—Ü–∏–π CRUD –≤ FastAPI - —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ–π –ø—Ä–æ—Ü–µ—Å—Å. –ú—ã –º–æ–∂–µ–º
–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ –∏ –º–µ—Ç–æ–¥—ã Python –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
—Å–æ–∑–¥–∞–Ω–∏—è, —á—Ç–µ–Ω–∏—è, –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏ —É–¥–∞–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö. –ú—ã –º–æ–∂–µ–º
–ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—à API —Å –ø–æ–º–æ—â—å—é —Ç–∞–∫–∏—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤, –∫–∞–∫ Postman –∏–ª–∏ Swagger
UI, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –æ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ.
"""
